<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arakha Tech Amataurs</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        body { background: #000; color: #ccc; font-family: sans-serif; margin: 0; overflow-x: hidden; }
        
        .nav { background: rgba(17, 17, 17, 0.9); backdrop-filter: blur(10px); padding: 10px; border-bottom: 1px solid #00ff41; position: sticky; top: 0; z-index: 100; }
        .nav-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .nav-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        
        /* á€á€œá€¯á€á€ºá€™á€»á€¬á€¸ á€á€…á€ºá€á€”á€ºá€¸á€á€Šá€ºá€¸á€–á€¼á€…á€ºá€…á€±á€›á€”á€º */
        .nav-bar-row { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #222; padding-top: 8px; }
        .nav-tabs { display: flex; gap: 15px; }
        .tab { font-size: 12px; color: #888; cursor: pointer; padding: 5px 0; white-space: nowrap; }
        .tab.active { color: #00ff41; border-bottom: 2px solid #00ff41; }

        .msg-btn { 
            position: relative; background: #222; color: #00ff41; border: 1px solid #00ff41; 
            padding: 5px 12px; border-radius: 20px; font-size: 10px; cursor: pointer; font-weight: bold;
        }
        .dm-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: red; border-radius: 50%; border: 2px solid #000; display: none; }

        @media (max-width: 480px) {
            b { font-size: 13px; }
            #user-display { font-size: 10px; }
            .tab { font-size: 11px; }
            .nav-tabs { gap: 15px; }
            button { padding: 4px 8px !important; font-size: 9px !important; }
            .msg-btn { padding: 4px 10px; font-size: 9px; }
        }

        .container { max-width: 700px; margin: 20px auto; padding: 10px; position: relative; z-index: 1; }
        .post-input { background: rgba(17, 17, 17, 0.85); padding: 25px; border: 1px solid #00ff41; margin-bottom: 20px; border-radius: 12px; }
        input, textarea { width: 100%; background: #000; border: 1px solid #444; color: #00ff41; padding: 12px; margin-top: 10px; outline: none; box-sizing: border-box; border-radius: 4px; }
        button { background: #00ff41; color: #000; border: none; padding: 12px; cursor: pointer; font-weight: bold; margin-top: 15px; border-radius: 4px; transition: 0.3s; }
        
        .card { background: rgba(22, 22, 22, 0.9); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; backdrop-filter: blur(5px); }
        .user { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user a { color: #00ff41; font-weight: bold; font-size: 15px; text-decoration: none; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #333; display: flex; align-items: center; justify-content: center; background: #111; font-size: 25px; overflow: hidden; object-fit: cover; }
        
        .online-dot { width: 8px; height: 8px; background: #00ff41; border-radius: 50%; display: inline-block; border: 1px solid #000; margin-left: 3px; }
        .badge { font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 5px; background: #00ff41; color: #000; font-weight: bold; }
        
        .reply-box { margin-top: 10px; padding-left: 15px; border-left: 2px solid #00ff41; font-size: 13px; }
        #preview-img { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-top: 10px; border: 1px dashed #00ff41; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div class="nav">
    <div class="nav-top">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="logo.png" alt="Logo" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px; border: 1px solid #00ff41;">
            <div>
                <b style="color:#00ff41; font-size: 14px;">ARAKHA_FORUM</b>
                <div style="font-size: 9px; color: #666; margin-top: 3px;">
                    ON: <span id="online-count">0</span> | TOT: <span id="total-count">0</span>
                </div>
            </div>
        </div>

        <div class="nav-right">
            <div id="user-display" style="color: #00ff41; font-weight: bold; font-size: 10px;"></div>
            <div style="display: flex; gap: 5px;">
                <button onclick="goToProfile()" style="background:transparent; border:1px solid #00ff41; color:#00ff41; padding:4px 8px; font-size: 9px; cursor: pointer; border-radius: 4px;">PROFILE</button>
                <button onclick="logout()" style="background:#ff4444; color:#fff; border:none; padding:4px 8px; font-size: 9px; cursor: pointer; border-radius: 4px;">LOGOUT</button>
            </div>
        </div>
    </div>

    <div class="nav-bar-row">
        <div class="nav-tabs">
            <div class="tab active" id="tab-latest" onclick="switchTab('latest')">á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€„á€ºá€á€…á€¬</div>
            <div class="tab" id="tab-popular" onclick="switchTab('popular')">á€”á€¬á€™á€Šá€ºá€€á€¼á€®á€¸</div>
        </div>
        <button class="msg-btn" onclick="window.location.href='chat_list.html'">
            ğŸ’¬ MESSAGES 
            <span id="dm-alert" class="dm-dot"></span>
        </button>
    </div>
</div>

<div class="container">
    <div class="post-input">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #00ff41; font-size: 20px;">á€›á€€á€¹á€á€­á€¯á€„á€ºá€á€¬á€¸á€¡á€á€»á€„á€ºá€¸á€á€»á€„á€ºá€¸ á€†á€½á€±á€¸á€”á€½á€±á€¸á€€á€á€ºá€™á€±</h2>
            <p style="margin: 5px 0 0 0; color: #aaa; font-size: 14px;">...á€œá€­á€¯á€¡á€•á€ºá€…á€¬á€á€­á€Ÿá€­á€€á€± á€•á€­á€¯á€·á€…á€ºá€á€„á€ºá€œá€­á€¯á€· á€¡á€€á€¼á€¶á€•á€¼á€¯á€á€€á€á€ºá€•á€«...</p>
        </div>
        <input type="text" id="t" placeholder="á€‚á€±á€«á€„á€ºá€¸á€…á€­á€¯á€„á€º (Title)">
        <textarea id="c" rows="3" placeholder="á€¡á€€á€¼á€±á€¬á€„á€ºá€¸á€¡á€›á€¬..."></textarea>
        
        <img id="preview-img">
        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="showPreview(this)">
        
        <div style="display: flex; gap: 10px;">
            <button onclick="document.getElementById('imageInput').click()" style="background:#222; color:#00ff41; border:1px solid #00ff41; flex: 1;">ğŸ–¼ï¸ á€•á€¯á€¶á€›á€½á€±á€¸á€™á€±</button>
            <button onclick="post()" id="postBtn" style="flex: 2;">POST á€á€„á€ºá€™á€±</button>
        </div>
        <div id="upload-status" style="font-size: 10px; color: #888; margin-top: 5px; text-align: center;"></div>
    </div>
    <div id="feed"></div>
</div>

<script>
    // --- 1. Matrix Background ---
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const matrixText = "ARAKHA010101";
    const fontSize = 16;
    const drops = Array(Math.floor(canvas.width / fontSize)).fill(1);
    function drawMatrix() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.05)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#00ff41"; ctx.font = fontSize + "px monospace";
        drops.forEach((y, i) => {
            const char = matrixText[Math.floor(Math.random() * matrixText.length)];
            ctx.fillText(char, i * fontSize, y * fontSize);
            if (y * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        });
    }
    setInterval(drawMatrix, 50);

    // --- 2. Firebase Setup ---
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app",
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    // --- 3. Utilities ---
    function escapeHTML(str) {
        if (!str) return "";
        return str.replace(/[&<>"']/g, function(m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
        });
    }

    function formatText(text, postId) {
        const limit = 200;
        if (text.length <= limit) return text;
        const shortText = text.substring(0, limit);
        return `
            <span id="short-${postId}">${shortText}...</span>
            <span id="full-${postId}" style="display:none;">${text}</span>
            <a href="javascript:void(0)" id="btn-${postId}" onclick="toggleReadMore('${postId}')" style="color:#00ff41; font-size:12px; text-decoration:none;"> [Read More]</a>
        `;
    }

    function toggleReadMore(postId) {
        const short = document.getElementById(`short-${postId}`);
        const full = document.getElementById(`full-${postId}`);
        const btn = document.getElementById(`btn-${postId}`);
        if (full.style.display === "none") {
            full.style.display = "inline"; short.style.display = "none"; btn.innerText = " [Show Less]";
        } else {
            full.style.display = "none"; short.style.display = "inline"; btn.innerText = " [Read More]";
        }
    }

    function getAvatarHTML(user) {
        if (user.profilePic && user.profilePic.startsWith('http')) {
            return `<img src="${user.profilePic}" class="avatar">`;
        } else {
            return `<div class="avatar">${user.profilePic || "ğŸ‘¤"}</div>`;
        }
    }

    // --- 4. Core Logic ---
    let userDataCache = {};
    let postsData = [];
    let currentTab = 'latest';

    db.ref('users').on('value', snap => { userDataCache = snap.val() || {}; renderFeed(); });
    db.ref('posts').on('value', snap => {
        postsData = [];
        snap.forEach(child => { postsData.push({ key: child.key, ...child.val() }); });
        renderFeed();
    });

    function renderFeed() {
        const feed = document.getElementById('feed');
        feed.innerHTML = "";
        let items = [...postsData];
        if (currentTab === 'latest') items.reverse();
        else items.sort((a, b) => (b.likes || 0) - (a.likes || 0));

        items.forEach(p => {
            const user = userDataCache[p.uid] || {};
            const isOnline = user.isOnline ? '<span class="online-dot" title="Online"></span>' : '';
            const badge = user.role === 'admin' ? '<span class="badge">DEV</span>' : '';
            
            let repliesHTML = "";
            if (p.replies) {
                Object.values(p.replies).forEach(r => {
                    const rU = userDataCache[r.uid] || {};
                    let replyAvatar = rU.profilePic && rU.profilePic.startsWith('http') ? 
                        `<img src="${rU.profilePic}" style="width:20px; height:20px; border-radius:50%; object-fit:cover; vertical-align:middle; border:1px solid #444;">` : 
                        `<span style="font-size:14px; vertical-align:middle;">${rU.profilePic || 'ğŸ‘¤'}</span>`;

                    repliesHTML += `
                        <div style="margin-top:8px; font-size:13px; color:#ccc;">
                            ${replyAvatar} 
                            <a href="profile.html?id=${r.uid}" style="color:#00ff41; text-decoration:none; font-weight:bold;">
                                @${rU.username || r.u}:
                            </a> 
                            <span style="color:#eee;">${r.m}</span>
                        </div>`;
                });
            }

            const card = document.createElement('div');
            card.className = "card";
            card.innerHTML = `
                <div class="user">
                    ${getAvatarHTML(user)}
                    <div>
                        <a href="profile.html?id=${p.uid}">@${user.username || p.u}</a> ${isOnline} ${badge}
                        <div style="font-size:9px; color:#555;">${new Date(p.time).toLocaleString()}</div>
                    </div>
                </div>
                <div style="color:#fff; font-weight:bold; margin-bottom:5px; font-size:18px;">${p.t}</div>
                <p style="margin:0; font-size:14px; line-height:1.5;">${formatText(p.c, p.key)}</p>
                ${p.img ? `<img src="${p.img}" style="width:100%; border-radius:8px; margin-top:10px; border:1px solid #333;">` : ''}
                <div style="margin-top:10px; font-size:12px; display:flex; gap:15px;">
                    <span style="color:#00ff41; cursor:pointer;" onclick="like('${p.key}')">â¤ï¸ Like (${p.likes || 0})</span>
                    <span style="color:#888; cursor:pointer;" onclick="reply('${p.key}')">ğŸ’¬ Reply</span>
                </div>
                <div class="reply-box">${repliesHTML}</div>`;
            feed.appendChild(card);
        });
    }

    // --- 5. Actions ---
    function showPreview(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-img').style.display = 'block'; };
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function post() {
        const t = document.getElementById('t').value;
        const c = document.getElementById('c').value;
        const file = document.getElementById('imageInput').files[0];
        const user = firebase.auth().currentUser;
        const btn = document.getElementById('postBtn');
        const status = document.getElementById('upload-status');

        if(!user || (!t && !c)) return;
        btn.disabled = true; status.innerText = "DATA_SENDING...";

        let imgUrl = null;
        if (file) {
            const fd = new FormData(); fd.append("image", file);
            try {
                const res = await fetch("https://api.imgbb.com/1/upload?key=926060156d59194f53e97f7cec5ff5a2", {method:"POST", body:fd});
                const data = await res.json();
                imgUrl = data.success ? data.data.url : null;
            } catch (e) { console.error(e); }
        }

        db.ref("posts").push({
            uid: user.uid, u: user.email.split('@')[0],
            t: escapeHTML(t), c: escapeHTML(c), img: imgUrl,
            time: Date.now(), likes: 0
        }).then(() => {
            document.getElementById('t').value = ""; document.getElementById('c').value = "";
            document.getElementById('preview-img').style.display = 'none';
            btn.disabled = false; status.innerText = "";
        });
    }

    function reply(id) {
        const m = prompt("Reply á€•á€¼á€”á€ºá€™á€± -");
        const user = firebase.auth().currentUser;
        if(m && user) {
            db.ref(`posts/${id}/replies`).push({ uid: user.uid, u: user.email.split('@')[0], m: escapeHTML(m) });
        }
    }

    function like(id) { db.ref(`posts/${id}/likes`).transaction(c => (c || 0) + 1); }
    function switchTab(t) {
        currentTab = t;
        document.getElementById('tab-latest').classList.toggle('active', t==='latest');
        document.getElementById('tab-popular').classList.toggle('active', t==='popular');
        renderFeed();
    }
    function goToProfile() { const u = firebase.auth().currentUser; if(u) window.location.href = "profile.html?id=" + u.uid; }

    // --- 6. Auth & Presence & DM Notification ---
    firebase.auth().onAuthStateChanged(user => {
        if (!user) window.location.href = "index.html";
        else {
            const sRef = db.ref('users/' + user.uid);
            sRef.update({ isOnline: true });
            sRef.onDisconnect().update({ isOnline: false, lastSeen: Date.now() });
            sRef.on('value', s => { 
                const data = s.val() || {};
                document.getElementById('user-display').innerText = "á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° - " + (data.username || user.email.split('@')[0]); 
            });

            // á€…á€¬á€¡á€á€…á€ºá€á€„á€ºá€œá€»á€¾á€„á€º á€¡á€”á€®á€…á€€á€ºá€•á€¼á€›á€”á€º
            db.ref('dms').on('value', snapshot => {
                let hasNew = false;
                snapshot.forEach(room => {
                    if (room.key.includes(user.uid)) {
                        const msgs = Object.values(room.val());
                        if (msgs[msgs.length - 1].sender !== user.uid) hasNew = true;
                    }
                });
                document.getElementById('dm-alert').style.display = hasNew ? 'block' : 'none';
            });
        }
    });

    db.ref('users').on('value', s => {
        document.getElementById('total-count').innerText = s.numChildren();
        let on = 0; s.forEach(u => { if(u.val().isOnline) on++; });
        document.getElementById('online-count').innerText = on;
    });

    function logout() { 
        if (confirm("á€œá€¬á€¸á€•á€«á€–á€­á€¯á€·á€šá€¬á€œá€¬á€¸?(á€¡á€¬á€¸á€€á€±á€œá€¬á€œá€Šá€ºá€•á€«)")) {
            firebase.auth().signOut().then(() => window.location.href = "index.html");
        } 
    }
    // AI Window á€•á€­á€á€º/á€–á€½á€„á€·á€º á€œá€¯á€•á€ºá€–á€­á€¯á€·
function toggleAIChat() {
    const win = document.getElementById('ai-window');
    win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
}

async function askAI() {
    const input = document.getElementById('ai-input');
    const msgDiv = document.getElementById('ai-messages');
    const userMsg = input.value.trim();

    if (!userMsg) return;

    // User á€›á€²á€· á€…á€¬á€€á€­á€¯ á€¡á€›á€„á€ºá€•á€¼á€™á€šá€º
    msgDiv.innerHTML += `<div style="color: #fff; margin-top: 5px;">ğŸ‘¤: ${userMsg}</div>`;
    input.value = "";
    msgDiv.scrollTop = msgDiv.scrollHeight;

    const apiKey = "AIzaSyCO6AnWclvWyByCcRjsenFOTgwEQh_gyXs"; 
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    // --- á€›á€€á€¹á€á€­á€¯á€„á€ºá€œá€­á€¯ á€•á€¼á€”á€ºá€–á€¼á€±á€–á€­á€¯á€· PROMPT á€’á€®á€™á€¾á€¬ á€‘á€Šá€·á€ºá€œá€­á€¯á€€á€ºá€•á€¼á€® ---
    const promptInstructions = `You are a helpful assistant for ARAKHA_FORUM. 
    Rule 1: Always reply in Rakhine language (Rakhine dialect) using Myanmar Unicode script.
    Rule 2: Use friendly terms like 'á€€á€­á€¯á€€á€­á€¯', 'á€Šá€®á€œá€±á€¸', 'á€¡á€á€»á€±'.
    Rule 3: If asked about tech, explain simply in Rakhine.
    User message: `;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ 
                    parts: [{ text: promptInstructions + userMsg }] 
                }]
            })
        });

        const data = await response.json();
        
        if (data.candidates && data.candidates[0].content.parts[0].text) {
            const aiResponse = data.candidates[0].content.parts[0].text;
            msgDiv.innerHTML += `<div style="margin-top: 5px; line-height: 1.5;">ğŸ¤–: ${aiResponse}</div>`;
        } else {
            throw new Error("Invalid Response");
        }

    } catch (error) {
        msgDiv.innerHTML += `<div style="color: red; margin-top: 5px;">ğŸ¤–: á€¡á€™á€¾á€¬á€¸á€á€…á€ºá€á€¯ á€–á€¼á€…á€ºá€œá€¬á€¸á€•á€«á€›á€± á€€á€­á€¯á€€á€­á€¯á‹ Key á€’á€«á€™á€¾á€™á€Ÿá€¯á€á€º á€œá€­á€¯á€„á€ºá€¸á€€á€­á€¯ á€…á€…á€ºá€€á€¼á€Šá€·á€ºá€•á€«á€¦á€¸á‹</div>`;
        console.error(error);
    }
    msgDiv.scrollTop = msgDiv.scrollHeight;
}

    const apiKey = "AIzaSyCO6AnWclvWyByCcRjsenFOTgwEQh_gyXs"; // á€€á€­á€¯á€€á€­á€¯á€· Key
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: userMsg + " (Please reply in Myanmar language)" }] }]
            })
        });

        const data = await response.json();
        const aiResponse = data.candidates[0].content.parts[0].text;

        // AI á€›á€²á€· á€¡á€–á€¼á€±á€€á€­á€¯ á€•á€¼á€™á€šá€º
        msgDiv.innerHTML += `<div style="margin-top: 5px;">ğŸ¤–: ${aiResponse}</div>`;
    } catch (error) {
        msgDiv.innerHTML += `<div style="color: red; margin-top: 5px;">ğŸ¤–: Error - Key á€™á€›á€á€±á€¬á€·á€˜á€°á€¸ á€‘á€„á€ºá€á€šá€º á€€á€­á€¯á€€á€­á€¯á‹</div>`;
        console.error(error);
    }
    msgDiv.scrollTop = msgDiv.scrollHeight;
}
</script>
    <div id="ai-chat-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; font-family: 'Courier New', monospace;">
    <div id="ai-toggle" onclick="toggleAIChat()" style="width: 50px; height: 50px; background: #00ff41; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 15px #00ff41;">
        <span style="font-size: 25px;">ğŸ¤–</span>
    </div>

    <div id="ai-window" style="display: none; width: 300px; height: 400px; background: #000; border: 2px solid #00ff41; border-radius: 10px; flex-direction: column; overflow: hidden; margin-bottom: 10px;">
        <div style="background: #00ff41; color: #000; padding: 10px; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between;">
            <span>ARAKHA_ASSISTANT</span>
            <span onclick="toggleAIChat()" style="cursor:pointer;">X</span>
        </div>
        <div id="ai-messages" style="flex: 1; padding: 10px; overflow-y: auto; font-size: 12px; color: #00ff41;">
            <div>ğŸ¤–: á€—á€»á€¬á€œá€ºá€œá€­á€¯á€·á€á€±á€«á€ºá€•á€«á€›á€±</div>
        </div>
        <div style="padding: 10px; border-top: 1px solid #333; display: flex; gap: 5px;">
            <input type="text" id="ai-input" placeholder="á€™á€±á€¸á€€á€¼á€Šá€·á€ºá€™á€±..." style="flex: 1; background: #111; border: 1px solid #00ff41; color: #00ff41; padding: 5px; font-size: 12px;">
            <button onclick="askAI()" style="background: #00ff41; color: #000; border: none; padding: 5px 10px; cursor: pointer; font-size: 10px; font-weight: bold;">SEND</button>
        </div>
    </div>
</div>
</body>
</html>
