<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arakha Tech Amataurs</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        /* Matrix & Body */
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        body { background: #000; color: #ccc; font-family: sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Navbar */
        .nav { background: rgba(17, 17, 17, 0.9); backdrop-filter: blur(10px); padding: 10px; border-bottom: 1px solid #00ff41; position: sticky; top: 0; z-index: 100; }
        .nav-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .nav-right { display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        .nav-bar-row { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #222; padding-top: 8px; }
        .nav-tabs { display: flex; gap: 15px; }
        .tab { font-size: 12px; color: #888; cursor: pointer; padding: 5px 0; white-space: nowrap; }
        .tab.active { color: #00ff41; border-bottom: 2px solid #00ff41; }

        .msg-btn { 
            position: relative; background: #222; color: #00ff41; border: 1px solid #00ff41; 
            padding: 5px 12px; border-radius: 20px; font-size: 10px; cursor: pointer; font-weight: bold;
        }
        .dm-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: red; border-radius: 50%; border: 2px solid #000; display: none; }

        @media (max-width: 480px) {
            b { font-size: 13px; }
            #user-display { font-size: 10px; }
            .tab { font-size: 11px; }
            button { padding: 4px 8px !important; font-size: 9px !important; }
        }

        /* Container & Cards */
        .container { max-width: 700px; margin: 20px auto; padding: 10px; position: relative; z-index: 1; }
        .post-input { background: rgba(17, 17, 17, 0.85); padding: 25px; border: 1px solid #00ff41; margin-bottom: 20px; border-radius: 12px; }
        input, textarea { width: 100%; background: #000; border: 1px solid #444; color: #00ff41; padding: 12px; margin-top: 10px; outline: none; box-sizing: border-box; border-radius: 4px; }
        button { background: #00ff41; color: #000; border: none; padding: 12px; cursor: pointer; font-weight: bold; margin-top: 15px; border-radius: 4px; transition: 0.3s; }
        
        .card { background: rgba(22, 22, 22, 0.9); padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #222; backdrop-filter: blur(5px); }
        .user { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user a { color: #00ff41; font-weight: bold; font-size: 15px; text-decoration: none; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 1px solid #333; display: flex; align-items: center; justify-content: center; background: #111; font-size: 25px; overflow: hidden; object-fit: cover; }
        
        .online-dot { width: 8px; height: 8px; background: #00ff41; border-radius: 50%; display: inline-block; border: 1px solid #000; margin-left: 3px; }
        .badge { font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 5px; background: #00ff41; color: #000; font-weight: bold; }
        
        .reply-box { margin-top: 10px; padding-left: 15px; border-left: 2px solid #00ff41; font-size: 13px; }
        #preview-img { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-top: 10px; border: 1px dashed #00ff41; }

        /* AI Chat Window Interface */
        #ai-btn { position: fixed; bottom: 20px; right: 20px; background: #00ff41; color: #000; border: none; padding: 12px 20px; border-radius: 50px; font-weight: bold; cursor: pointer; z-index: 1000; box-shadow: 0 0 15px #00ff41; }
        #ai-window { position: fixed; bottom: 80px; right: 20px; width: 300px; height: 400px; background: rgba(10, 10, 10, 0.95); border: 1px solid #00ff41; border-radius: 12px; display: none; flex-direction: column; z-index: 1000; overflow: hidden; }
        #ai-header { background: #00ff41; color: #000; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        #ai-messages { flex: 1; padding: 10px; overflow-y: auto; font-size: 12px; display: flex; flex-direction: column; gap: 8px; }
        .msg.bot { background: #222; color: #00ff41; padding: 8px; border-radius: 8px; align-self: flex-start; border: 1px solid #333; }
        .msg.user { background: #00ff41; color: #000; padding: 8px; border-radius: 8px; align-self: flex-end; }
        #ai-input-area { display: flex; padding: 10px; border-top: 1px solid #333; gap: 5px; }
        #ai-input-area input { flex: 1; background: #000; border: 1px solid #00ff41; color: #00ff41; padding: 8px; border-radius: 4px; margin-top: 0; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<button id="ai-btn" onclick="toggleAI()">ğŸ¤– ASK AI</button>
<div id="ai-window">
    <div id="ai-header"><span>á€›á€€á€¹á€á€­á€¯á€„á€ºá€™á€á€»á€± (AI)</span><span onclick="toggleAI()" style="cursor:pointer;">âœ–</span></div>
    <div id="ai-messages"><div class="msg bot">á€á€¬á€œá€®á€…á€½á€•á€«! á€‡á€¬á€¡á€€á€°á€Šá€®á€•á€®á€¸á€›á€•á€«á€–á€­á€¯á€·á€œá€²?</div></div>
    <div id="ai-input-area">
        <input type="text" id="ai-query" placeholder="á€™á€­á€”á€ºá€¸á€€á€¼á€Šá€·á€ºá€™á€±...">
        <button onclick="askAI()" style="margin-top:0; padding: 5px 10px; font-size: 11px;">á€•á€­á€¯á€·á€™á€±</button>
    </div>
</div>

<div class="nav">
    <div class="nav-top">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="logo.png" alt="Logo" style="width: 32px; height: 32px; object-fit: cover; border-radius: 4px; border: 1px solid #00ff41;">
            <div>
                <b style="color:#00ff41; font-size: 14px;">ARAKHA_FORUM</b>
                <div style="font-size: 9px; color: #666; margin-top: 3px;">
                    ON: <span id="online-count">0</span> | TOT: <span id="total-count">0</span>
                </div>
            </div>
        </div>
        <div class="nav-right">
            <div id="user-display" style="color: #00ff41; font-weight: bold; font-size: 10px;"></div>
            <div style="display: flex; gap: 5px;">
                <button onclick="goToProfile()" style="background:transparent; border:1px solid #00ff41; color:#00ff41; padding:4px 8px; font-size: 9px; cursor: pointer; border-radius: 4px;">PROFILE</button>
                <button onclick="logout()" style="background:#ff4444; color:#fff; border:none; padding:4px 8px; font-size: 9px; cursor: pointer; border-radius: 4px;">LOGOUT</button>
            </div>
        </div>
    </div>
    <div class="nav-bar-row">
        <div class="nav-tabs">
            <div class="tab active" id="tab-latest" onclick="switchTab('latest')">á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸á€á€„á€ºá€á€…á€¬</div>
            <div class="tab" id="tab-popular" onclick="switchTab('popular')">á€”á€¬á€™á€Šá€ºá€€á€¼á€®á€¸</div>
        </div>
        <button class="msg-btn" onclick="window.location.href='chat_list.html'">ğŸ’¬ MESSAGES <span id="dm-alert" class="dm-dot"></span></button>
    </div>
</div>

<div class="container">
    <div class="post-input">
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: #00ff41; font-size: 20px;">á€›á€€á€¹á€á€­á€¯á€„á€ºá€á€¬á€¸á€¡á€á€»á€„á€ºá€¸á€á€»á€„á€ºá€¸ á€†á€½á€±á€¸á€”á€½á€±á€¸á€€á€á€ºá€™á€±</h2>
        </div>
        <input type="text" id="t" placeholder="á€‚á€±á€«á€„á€ºá€¸á€…á€­á€¯á€„á€º (Title)">
        <textarea id="c" rows="3" placeholder="á€¡á€€á€¼á€±á€¬á€„á€ºá€¸á€¡á€›á€¬..."></textarea>
        <img id="preview-img">
        <input type="file" id="imageInput" accept="image/*" style="display:none;" onchange="showPreview(this)">
        <div style="display: flex; gap: 10px;">
            <button onclick="document.getElementById('imageInput').click()" style="background:#222; color:#00ff41; border:1px solid #00ff41; flex: 1;">ğŸ–¼ï¸ á€•á€¯á€¶á€›á€½á€±á€¸á€™á€±</button>
            <button onclick="post()" id="postBtn" style="flex: 2;">POST á€á€„á€ºá€™á€±</button>
        </div>
    </div>
    <div id="feed"></div>
</div>

<script>
    // --- 1. Matrix ---
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const matrixText = "ARAKHA010101";
    const drops = Array(Math.floor(canvas.width / 16)).fill(1);
    function drawMatrix() {
        ctx.fillStyle = "rgba(0, 0, 0, 0.05)"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#00ff41"; ctx.font = "16px monospace";
        drops.forEach((y, i) => {
            ctx.fillText(matrixText[Math.floor(Math.random()*matrixText.length)], i*16, y*16);
            if (y*16 > canvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        });
    }
    setInterval(drawMatrix, 50);

    // --- 2. Firebase Setup ---
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app",
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    // --- 3. AI Functions ---
    function toggleAI() {
        const win = document.getElementById('ai-window');
        win.style.display = (win.style.display === 'none' || win.style.display === '') ? 'flex' : 'none';
    }
    async function askAI() {
    const queryInput = document.getElementById('ai-query');
    const query = queryInput.value.trim();
    if (!query) return;

    const msgDiv = document.getElementById('ai-messages');
    msgDiv.innerHTML += `<div class="msg user">${query}</div>`;
    queryInput.value = "";

    const botMsgId = "bot-" + Date.now();
    msgDiv.innerHTML += `<div class="msg bot" id="${botMsgId}">á€…á€‰á€ºá€¸á€…á€¬á€¸á€”á€®á€›á€±...</div>`;
    msgDiv.scrollTop = msgDiv.scrollHeight;

    // --- Configuration ---
    // á€€á€­á€¯á€€á€­á€¯ á€¡á€á€¯á€•á€±á€¸á€á€²á€· Gemini Key á€€á€­á€¯ á€‘á€Šá€·á€ºá€‘á€¬á€¸á€•á€«á€á€šá€º
    const API_KEY = "AIzaSyCO6AnWclvWyByCcRjsenFOTgwEQh_gyXs"; 
    
    // á€’á€®á€”á€±á€›á€¬á€™á€¾á€¬ á€€á€­á€¯á€€á€­á€¯á€·á€›á€²á€· Cloudflare Worker URL á€€á€­á€¯ á€‘á€Šá€·á€ºá€•á€±á€¸á€•á€« (á€¥á€•á€™á€¬- https://gemini-proxy.xxx.workers.dev)
    const PROXY_URL = "á€€á€­á€¯á€€á€­á€¯á€·_WORKER_URL_á€’á€®á€™á€¾á€¬á€‘á€Šá€·á€ºá€•á€«"; 

    try {
        // Cloudflare Proxy á€€á€”á€±á€á€†á€„á€·á€º Gemini á€†á€® á€á€½á€¬á€¸á€™á€¾á€¬á€–á€¼á€…á€ºá€œá€­á€¯á€· á€’á€±á€á€€á€”á€·á€ºá€á€á€ºá€á€»á€€á€º á€™á€›á€¾á€­á€á€±á€¬á€·á€•á€«á€˜á€°á€¸
        const response = await fetch(`${PROXY_URL}/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: query }]
                }]
            })
        });

        const data = await response.json();

        if (data.candidates && data.candidates[0].content.parts[0].text) {
            let aiText = data.candidates[0].content.parts[0].text;
            
            // á€…á€¬á€á€¬á€¸á€‘á€²á€™á€¾á€¬ á€•á€«á€œá€¬á€”á€­á€¯á€„á€ºá€á€²á€· Markdown á€á€„á€ºá€¹á€€á€±á€á€á€½á€±á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€•á€±á€¸á€á€¬á€•á€«
            document.getElementById(botMsgId).innerText = aiText;
        } else if (data.error) {
            document.getElementById(botMsgId).innerText = "Error: " + data.error.message;
        } else {
            document.getElementById(botMsgId).innerText = "á€¡á€–á€¼á€± á€™á€›á€›á€¾á€­á€•á€«á€˜á€°á€¸á‹";
        }
    } catch (error) {
        console.error("Gemini Error:", error);
        document.getElementById(botMsgId).innerText = "á€á€»á€­á€á€ºá€†á€€á€ºá€™á€¾á€¯ á€¡á€™á€¾á€¬á€¸á€–á€¼á€…á€ºá€á€½á€¬á€¸á€•á€«á€›á€±á‹ Worker URL á€€á€­á€¯ á€á€±á€á€»á€¬á€•á€¼á€”á€ºá€…á€…á€ºá€•á€±á€¸á€•á€«á‹";
    }
    
    msgDiv.scrollTop = msgDiv.scrollHeight;
}
    // --- 4. Forum Functions (á€™á€°á€œá€¡á€á€­á€¯á€„á€ºá€¸ á€¡á€€á€¯á€”á€ºá€•á€¼á€”á€ºá€‘á€Šá€·á€ºá€‘á€¬á€¸á€á€Šá€º) ---
    let userDataCache = {}; let postsData = []; let currentTab = 'latest';

    function escapeHTML(str) { return str ? str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) : ""; }

    db.ref('users').on('value', snap => {
        userDataCache = snap.val() || {};
        document.getElementById('total-count').innerText = snap.numChildren();
        let on = 0; snap.forEach(u => { if(u.val().isOnline) on++; });
        document.getElementById('online-count').innerText = on;
        renderFeed();
    });

    db.ref('posts').on('value', snap => {
        postsData = []; snap.forEach(c => { postsData.push({ key: c.key, ...c.val() }); });
        renderFeed();
    });

    function renderFeed() {
        const feed = document.getElementById('feed'); feed.innerHTML = "";
        let items = [...postsData]; if (currentTab === 'latest') items.reverse(); else items.sort((a, b) => (b.likes || 0) - (a.likes || 0));
        
        items.forEach(p => {
            const user = userDataCache[p.uid] || {};
            const isOnline = user.isOnline ? '<span class="online-dot"></span>' : '';
            const badge = user.role === 'admin' ? '<span class="badge">DEV</span>' : '';
            
            let repliesHTML = "";
            if (p.replies) {
                Object.values(p.replies).forEach(r => {
                    const rU = userDataCache[r.uid] || {};
                    repliesHTML += `<div style="margin-top:8px; font-size:13px; color:#ccc;"><a href="profile.html?id=${r.uid}" style="color:#00ff41; text-decoration:none; font-weight:bold;">@${rU.username || r.u}:</a> ${r.m}</div>`;
                });
            }

            const card = document.createElement('div'); card.className = "card";
            card.innerHTML = `
                <div class="user"><div class="avatar">${user.profilePic && user.profilePic.startsWith('http') ? `<img src="${user.profilePic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : (user.profilePic || 'ğŸ‘¤')}</div>
                <div><a href="profile.html?id=${p.uid}">@${user.username || p.u}</a> ${isOnline} ${badge} <div style="font-size:9px; color:#555;">${new Date(p.time).toLocaleString()}</div></div></div>
                <div style="color:#fff; font-weight:bold; margin-bottom:5px; font-size:18px;">${p.t}</div>
                <p style="margin:0; font-size:14px;">${p.c}</p>
                ${p.img ? `<img src="${p.img}" style="width:100%; border-radius:8px; margin-top:10px;">` : ''}
                <div style="margin-top:10px; font-size:12px; display:flex; gap:15px;">
                    <span style="color:#00ff41; cursor:pointer;" onclick="like('${p.key}')">â¤ï¸ Like (${p.likes || 0})</span>
                    <span style="color:#888; cursor:pointer;" onclick="reply('${p.key}')">ğŸ’¬ Reply</span>
                </div>
                <div class="reply-box">${repliesHTML}</div>`;
            feed.appendChild(card);
        });
    }

    function showPreview(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { document.getElementById('preview-img').src = e.target.result; document.getElementById('preview-img').style.display = 'block'; }; reader.readAsDataURL(input.files[0]); } }

    async function post() {
        const t = document.getElementById('t').value; const c = document.getElementById('c').value;
        const file = document.getElementById('imageInput').files[0]; const user = firebase.auth().currentUser;
        if(!user || (!t && !c)) return;
        document.getElementById('postBtn').disabled = true;
        let imgUrl = null;
        if (file) {
            const fd = new FormData(); fd.append("image", file);
            try { const res = await fetch("https://api.imgbb.com/1/upload?key=926060156d59194f53e97f7cec5ff5a2", {method:"POST", body:fd}); const data = await res.json(); imgUrl = data.success ? data.data.url : null; } catch (e) {}
        }
        db.ref("posts").push({ uid: user.uid, u: user.email.split('@')[0], t: escapeHTML(t), c: escapeHTML(c), img: imgUrl, time: Date.now(), likes: 0 }).then(() => {
            document.getElementById('t').value = ""; document.getElementById('c').value = "";
            document.getElementById('preview-img').style.display = 'none';
            document.getElementById('postBtn').disabled = false;
        });
    }

    function reply(id) { const m = prompt("Reply á€•á€¼á€”á€ºá€™á€± -"); const user = firebase.auth().currentUser; if(m && user) db.ref(`posts/${id}/replies`).push({ uid: user.uid, u: user.email.split('@')[0], m: escapeHTML(m) }); }
    function like(id) { db.ref(`posts/${id}/likes`).transaction(c => (c || 0) + 1); }
    function switchTab(t) { currentTab = t; document.getElementById('tab-latest').classList.toggle('active', t==='latest'); document.getElementById('tab-popular').classList.toggle('active', t==='popular'); renderFeed(); }
    function goToProfile() { const u = firebase.auth().currentUser; if(u) window.location.href = "profile.html?id=" + u.uid; }

    firebase.auth().onAuthStateChanged(user => {
        if (!user) window.location.href = "index.html";
        else {
            db.ref('users/' + user.uid).update({ isOnline: true });
            db.ref('users/' + user.uid).onDisconnect().update({ isOnline: false });
            db.ref('users/' + user.uid).on('value', s => { document.getElementById('user-display').innerText = "á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€á€° - " + (s.val().username || user.email.split('@')[0]); });
        }
    });

    function logout() { if (confirm("á€œá€¬á€¸á€•á€«á€–á€­á€¯á€·á€šá€¬á€œá€¬á€¸?á€¡á€¬á€¸á€€á€±á€œá€¬á€œá€Šá€ºá€•á€«")) firebase.auth().signOut().then(() => window.location.href = "index.html"); }
</script>
</body>
</html>
