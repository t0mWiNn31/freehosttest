<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arakha Terminal - Secure DM</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: #050505; 
            color: #00ff41; 
            font-family: 'Courier New', Courier, monospace; 
            height: 100dvh; 
            display: flex; 
            justify-content: center; 
            overflow: hidden; 
        }
        .terminal-container { 
            width: 100%; 
            max-width: 600px; 
            height: 100dvh; 
            background: #0a0a0a; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #1a1a1a; 
            border-right: 1px solid #1a1a1a; 
        }
        
        /* Header */
        .terminal-header { 
            background: #111; 
            padding: 10px 15px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-bottom: 2px solid #00ff41; 
        }
        .back-btn { 
            background: none; 
            border: 1px solid #00ff41; 
            color: #00ff41; 
            padding: 5px 10px; 
            cursor: pointer; 
            font-size: 11px; 
            border-radius: 4px;
            text-decoration: none;
        }
        #chat-with-avatar { 
            width: 35px; 
            height: 35px; 
            border-radius: 50%; 
            border: 1px solid #00ff41; 
            object-fit: cover; 
            background: #000;
        }
        #title-container { flex: 1; display: flex; flex-direction: column; }
        #title { font-size: 13px; font-weight: bold; color: #00ff41; }
        #status-text { font-size: 9px; opacity: 0.6; }

        .status-dot { width: 10px; height: 10px; background: #333; border-radius: 50%; }
        .status-online { background: #00ff41; box-shadow: 0 0 8px #00ff41; }

        /* Messages */
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            background: linear-gradient(rgba(0,0,0,0.9), rgba(0,0,0,0.9)), url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
        }

        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.others { align-self: flex-start; }
        
        .bubble { 
            padding: 10px 14px; 
            border-radius: 15px; 
            font-size: 14px; 
            word-break: break-word; 
            line-height: 1.4; 
        }
        .mine .bubble { color: #fff; background: #004d1a; border: 1px solid #00ff41; border-bottom-right-radius: 2px; }
        .others .bubble { color: #00ff41; background: #1a1a1a; border: 1px solid #333; border-bottom-left-radius: 2px; }
        
        .time-tag { font-size: 8px; opacity: 0.5; margin-top: 5px; display: block; }
        .mine .time-tag { text-align: right; }

        /* Input Area */
        .input-area { 
            padding: 15px; 
            background: #111; 
            border-top: 1px solid #333; 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        input { 
            flex: 1; 
            background: #000; 
            border: 1px solid #333; 
            color: #00ff41; 
            padding: 12px 18px; 
            outline: none; 
            border-radius: 25px; 
            font-size: 14px; 
            font-family: inherit;
        }
        input:focus { border-color: #00ff41; }
        button#sendBtn { 
            background: #00ff41; 
            color: #000; 
            border: none; 
            width: 42px; 
            height: 42px; 
            border-radius: 50%; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-shrink: 0;
            transition: 0.2s;
        }
        button#sendBtn:active { transform: scale(0.9); }
    </style>
</head>
<body>

<div class="terminal-container">
    <div class="terminal-header">
        <a href="forum.html" class="back-btn">BACK</a>
        <div id="header-avatar-container">
            <div id="chat-with-avatar" style="display: flex; align-items: center; justify-content: center; font-size: 20px;">üë§</div>
        </div>
        <div id="title-container">
            <div id="title">SECURE_CHANNEL</div>
            <div id="status-text">OFFLINE</div>
        </div>
        <div id="status-dot" class="status-dot"></div>
    </div>

    <div id="messages"></div>

    <div class="input-area" id="input-container" style="display: none;">
        <input type="text" id="msg" placeholder="Type a message..." autocomplete="off" onkeypress="if(event.key==='Enter')send()">
        <button id="sendBtn" onclick="send()">‚û§</button>
    </div>
</div>

<script>
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app", 
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUid = urlParams.get('id');

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.replace("index.html");
        } else {
            // ·ÄÄ·Ä≠·ÄØ·Äö·Ä∑·Ä∫ Online Status ·ÄÄ·Ä≠·ÄØ Update ·Äú·ÄØ·Äï·Ä∫·Äô·Äö·Ä∫
            const myPresence = db.ref('users/' + user.uid);
            myPresence.update({ isOnline: true, lastSeen: firebase.database.ServerValue.TIMESTAMP });
            myPresence.onDisconnect().update({ isOnline: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });

            if (targetUid) {
                document.getElementById('input-container').style.display = 'flex';
                setupChat(user.uid, targetUid);
            } else {
                document.getElementById('title').innerText = "SYSTEM::ERROR";
                document.getElementById('messages').innerHTML = `<div style="text-align:center; margin-top:50px; opacity:0.5;">·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äõ·Äî·Ä∫ User ·Äê·ÄÖ·Ä∫·Ä¶·Ä∏·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·Äõ·ÄΩ·Ä±·Ä∏·ÄÅ·Äª·Äö·Ä∫·Äï·Ä´·Äõ·Äæ·ÄÑ·Ä∫·Åã</div>`;
            }
        }
    });

    function setupChat(myUid, toUid) {
        // Room ID ·Äñ·Äî·Ä∫·Äê·ÄÆ·Ä∏·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        const roomId = myUid < toUid ? myUid + "_" + toUid : toUid + "_" + myUid;

        // ·ÅÅ·Åã ·Äê·ÄÖ·Ä∫·Äñ·ÄÄ·Ä∫·Äú·Ä∞ Profile ·ÄÄ·Ä≠·ÄØ ·Ä°·Äô·Äº·Ä≤·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·ÄÄ·Äº·Ää·Ä∑·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        db.ref('users/' + toUid).on('value', snap => {
            const data = snap.val() || {};
            
            // ·Äî·Ä¨·Äô·Ää·Ä∫·Äï·Äº·Äô·Äö·Ä∫
            document.getElementById('title').innerText = (data.username || "User").toUpperCase();
            
            // Avatar ·Äï·Äº·Äô·Äö·Ä∫
            const avatarBox = document.getElementById('header-avatar-container');
            if(data.profilePic && data.profilePic.startsWith('http')) {
                avatarBox.innerHTML = `<img src="${data.profilePic}" id="chat-with-avatar">`;
            } else {
                avatarBox.innerHTML = `<div id="chat-with-avatar" style="display: flex; align-items: center; justify-content: center; font-size: 20px;">${data.profilePic || 'üë§'}</div>`;
            }

            // Online Status & Dot
            const dot = document.getElementById('status-dot');
            const statusTxt = document.getElementById('status-text');
            if(data.isOnline === true) {
                dot.classList.add('status-online');
                statusTxt.innerText = "ONLINE_NOW";
                statusTxt.style.color = "#00ff41";
            } else {
                dot.classList.remove('status-online');
                statusTxt.innerText = "LAST_SEEN: " + (data.lastSeen ? new Date(data.lastSeen).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "OFFLINE");
                statusTxt.style.color = "#666";
            }
        });

        // ·ÅÇ·Åã ·ÄÖ·Ä¨·Äü·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏·Äî·Äæ·ÄÑ·Ä∑·Ä∫ ·ÄÖ·Ä¨·Ä°·Äû·ÄÖ·Ä∫·Äô·Äª·Ä¨·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÜ·ÄΩ·Ä≤·Äë·ÄØ·Äê·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        const msgDiv = document.getElementById('messages');
        msgDiv.innerHTML = ""; // ·Äõ·Äæ·ÄÑ·Ä∫·Ä∏·Äë·ÄØ·Äê·Ä∫·Äô·Äö·Ä∫

        db.ref("dms/" + roomId).on("child_added", snap => {
            const data = snap.val();
            const isMine = data.sender === myUid;
            const timeStr = new Date(data.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = 'msg-row ' + (isMine ? 'mine' : 'others');
            div.innerHTML = `
                <div class="msg-content">
                    <div class="bubble">
                        ${data.text}
                        <span class="time-tag">${timeStr}</span>
                    </div>
                </div>
            `;
            msgDiv.appendChild(div);
            msgDiv.scrollTop = msgDiv.scrollHeight; // ·Ä°·Ä±·Ä¨·ÄÄ·Ä∫·ÄÜ·ÄØ·Ä∂·Ä∏·ÄÄ·Ä≠·ÄØ ·ÄÜ·ÄΩ·Ä≤·ÄÅ·Äª·Äô·Äö·Ä∫
        });

        // ·ÅÉ·Åã ·ÄÖ·Ä¨·Äï·Ä≠·ÄØ·Ä∑·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏
        window.send = function() {
            const txt = document.getElementById('msg').value.trim();
            if(txt) {
                db.ref("dms/" + roomId).push({
                    sender: myUid,
                    text: txt,
                    time: firebase.database.ServerValue.TIMESTAMP
                });
                document.getElementById('msg').value = "";
            }
        };
    }
</script>
</body>
</html>
