<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arakha Terminal - Secure DM</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: #050505; 
            color: #00ff41; 
            font-family: 'Courier New', Courier, monospace; 
            height: 100dvh; 
            display: flex; 
            justify-content: center; 
            overflow: hidden; 
        }
        .terminal-container { 
            width: 100%; 
            max-width: 600px; 
            height: 100dvh; 
            background: #0a0a0a; 
            display: flex; 
            flex-direction: column; 
            border-left: 1px solid #1a1a1a; 
            border-right: 1px solid #1a1a1a; 
        }
        
        .terminal-header { 
            background: #111; 
            padding: 12px 15px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            border-bottom: 2px solid #00ff41; 
        }
        .back-btn { 
            background: none; 
            border: 1px solid #00ff41; 
            color: #00ff41; 
            padding: 5px 10px; 
            cursor: pointer; 
            font-size: 12px; 
            border-radius: 4px;
            text-decoration: none;
        }
        #header-avatar-container { display: flex; align-items: center; justify-content: center; }
        #chat-with-avatar { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #00ff41; object-fit: cover; }
        #title { font-size: 11px; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #00ff41; }
        .status-dot { width: 8px; height: 8px; background: #333; border-radius: 50%; }
        .status-online { background: #00ff41; box-shadow: 0 0 8px #00ff41; }

        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
            background-image: linear-gradient(rgba(0, 255, 65, 0.02) 1px, transparent 1px);
            background-size: 100% 20px;
        }

        .msg-row { display: flex; gap: 10px; max-width: 85%; }
        .msg-row.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg-row.others { align-self: flex-start; }
        
        .bubble { 
            padding: 10px 14px; 
            border-radius: 12px; 
            font-size: 14px; 
            word-break: break-word; 
            line-height: 1.4; 
            position: relative; 
        }
        .mine .bubble { color: #fff; background: rgba(0, 255, 65, 0.2); border: 1px solid #00ff41; border-bottom-right-radius: 2px; }
        .others .bubble { color: #00ff41; background: #1a1a1a; border: 1px solid #333; border-bottom-left-radius: 2px; }
        
        .time-tag { font-size: 8px; opacity: 0.5; margin-top: 5px; display: block; text-align: right; }

        .input-area { 
            padding: 15px; 
            background: #111; 
            border-top: 1px solid #333; 
            display: flex; 
            gap: 10px; 
            align-items: center;
        }
        input { 
            flex: 1; 
            background: #000; 
            border: 1px solid #333; 
            color: #00ff41; 
            padding: 12px 15px; 
            outline: none; 
            border-radius: 25px; 
            font-size: 14px; 
            font-family: inherit;
        }
        input:focus { border-color: #00ff41; }
        button#sendBtn { 
            background: #00ff41; 
            color: #000; 
            border: none; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

<div class="terminal-container">
    <div class="terminal-header">
        <a href="forum.html" class="back-btn">BACK</a>
        <div id="header-avatar-container"></div>
        <div id="title">INITIALIZING...</div>
        <div id="status-dot" class="status-dot"></div>
    </div>

    <div id="messages"></div>

    <div class="input-area" id="input-container" style="display: none;">
        <input type="text" id="msg" placeholder="Type a message..." autocomplete="off" onkeypress="if(event.key==='Enter')send()">
        <button id="sendBtn" onclick="send()">‚û§</button>
    </div>
</div>

<script>
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app", 
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();
    const auth = firebase.auth();

    const urlParams = new URLSearchParams(window.location.search);
    const targetUid = urlParams.get('id');

    auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.replace("index.html");
        } else {
            updatePresence(user.uid);
            if (targetUid) {
                document.getElementById('input-container').style.display = 'flex';
                setupChat(user.uid, targetUid);
            } else {
                document.getElementById('title').innerText = "SYSTEM::SELECT_USER";
                document.getElementById('messages').innerHTML = `
                    <div style="text-align:center; margin-top:50px; opacity:0.6;">
                        <p>·ÄÖ·ÄÄ·Ä¨·Ä∏·Äï·Äº·Ä±·Ä¨·Äô·Ää·Ä∑·Ä∫·Äû·Ä∞ ·Äô·Äõ·ÄΩ·Ä±·Ä∏·Äõ·Äû·Ä±·Ä∏·Äï·Ä´·Åã</p>
                        <p style="font-size:12px; margin-top:10px;">·Äñ·Ä≠·ÄØ·Äõ·Äô·Ä∫·Äë·Ä≤·Äô·Äæ User ·Äê·ÄÖ·Ä∫·Ä¶·Ä∏·Åè Profile ·ÄÄ·Ä≠·ÄØ·Äî·Äæ·Ä≠·Äï·Ä∫·Åç ·ÄÖ·Ä¨·Äï·Ä≠·ÄØ·Ä∑·Äï·Ä´·Äõ·Äæ·ÄÑ·Ä∫·Åã</p>
                    </div>`;
            }
        }
    });

    function updatePresence(uid) {
        const pRef = db.ref('users/' + uid);
        pRef.update({ isOnline: true, lastSeen: firebase.database.ServerValue.TIMESTAMP });
        pRef.onDisconnect().update({ isOnline: false, lastSeen: firebase.database.ServerValue.TIMESTAMP });
    }

    function setupChat(myUid, toUid) {
        const roomId = myUid < toUid ? myUid + "_" + toUid : toUid + "_" + myUid;

        // ·Äê·ÄÖ·Ä∫·Äñ·ÄÄ·Ä∫·Äú·Ä∞ Profile ·Äö·Ä∞·Äô·Äö·Ä∫
        db.ref('users/' + toUid).on('value', snap => {
            const data = snap.val() || {};
            document.getElementById('title').innerText = "DM::" + (data.username || "UNKNOWN").toUpperCase();
            
            const avatarContainer = document.getElementById('header-avatar-container');
            if(data.profilePic && data.profilePic.startsWith('http')) {
                avatarContainer.innerHTML = `<img src="${data.profilePic}" id="chat-with-avatar">`;
            } else {
                avatarContainer.innerHTML = `<div style="font-size:20px;">${data.profilePic || 'üë§'}</div>`;
            }

            const dot = document.getElementById('status-dot');
            if(data.isOnline) dot.classList.add('status-online');
            else dot.classList.remove('status-online');
        });

        // ·Äô·ÄÄ·Ä∫·ÄÜ·Ä±·Ä∑·Äê·ÄΩ·Ä± ·Äî·Ä¨·Ä∏·Äë·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äö·Ä∫
        db.ref("dms/" + roomId).off();
        db.ref("dms/" + roomId).limitToLast(50).on("child_added", snap => {
            const data = snap.val();
            const msgDiv = document.getElementById('messages');
            const isMine = data.sender === myUid;
            const timeStr = new Date(data.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const div = document.createElement('div');
            div.className = 'msg-row ' + (isMine ? 'mine' : 'others');
            div.innerHTML = `
                <div class="msg-content">
                    <div class="bubble">
                        ${data.text}
                        <span class="time-tag">${timeStr}</span>
                    </div>
                </div>
            `;
            msgDiv.appendChild(div);
            msgDiv.scrollTop = msgDiv.scrollHeight;
        });

        window.send = function() {
            const txt = document.getElementById('msg').value.trim();
            if(txt) {
                db.ref("dms/" + roomId).push({
                    sender: myUid,
                    text: txt,
                    time: firebase.database.ServerValue.TIMESTAMP
                });
                document.getElementById('msg').value = "";
            }
        };
    }
</script>
</body>
</html>
