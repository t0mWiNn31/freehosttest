<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arakha Community - Profile</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        #matrix-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        body { background: #000; color: #ccc; font-family: sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .profile-card { background: rgba(17, 17, 17, 0.9); border: 1px solid #00ff41; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; backdrop-filter: blur(10px); }
        
        /* Avatar Logic Styling */
        .avatar-container { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; }
        .avatar-display { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #00ff41; display: flex; align-items: center; justify-content: center; background: #111; font-size: 50px; overflow: hidden; object-fit: cover; }
        
        .upload-icon { position: absolute; bottom: 0; right: 0; background: #00ff41; color: #000; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; border: 2px solid #000; }

        input, textarea { width: 100%; background: #000; border: 1px solid #444; color: #00ff41; padding: 10px; margin-top: 10px; border-radius: 4px; outline: none; box-sizing: border-box; }
        button { width: 100%; background: #00ff41; color: #000; border: none; padding: 12px; margin-top: 15px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .back-btn { background: transparent; color: #00ff41; border: 1px solid #00ff41; margin-top: 10px; }
    </style>
</head>
<body>

<canvas id="matrix-canvas"></canvas>

<div class="profile-card">
    <div class="avatar-container">
        <div id="avatar-view" class="avatar-display">ðŸ‘¤</div>
        <label for="img-input" class="upload-icon">ðŸ“·</label>
        <input type="file" id="img-input" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
    </div>

    <h3 id="display-name" style="color:#00ff41; margin: 10px 0;">User_Name</h3>
    <p id="user-email" style="font-size: 12px; color: #666;"></p>

    <input type="text" id="username" placeholder="á€”á€¬á€™á€±á€žá€…á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€™á€±">
    <textarea id="bio" rows="2" placeholder="á€€á€­á€¯á€šá€·á€ºá€¡á€€á€¼á€±á€¬á€„á€ºá€¸ á€…á€€á€±á€á€•á€½á€±..."></textarea>
    
    <button onclick="saveProfile()" id="saveBtn">UPDATE_PROFILE</button>
    <button class="back-btn" onclick="window.location.href='forum.html'">BACK_TO_FORUM</button>
    <div id="status" style="font-size: 10px; margin-top: 10px; color: #00ff41;"></div>
</div>

<script>
    // --- Firebase Config ---
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app",
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();

    // Matrix Background
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const drops = Array(Math.floor(canvas.width / 16)).fill(1);
    function draw() {
        ctx.fillStyle = "rgba(0,0,0,0.05)"; ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "#00ff41"; ctx.font = "16px monospace";
        drops.forEach((y, i) => {
            ctx.fillText("01"[Math.floor(Math.random()*2)], i*16, y*16);
            if(y*16 > canvas.height && Math.random() > 0.975) drops[i] = 0;
            drops[i]++;
        });
    }
    setInterval(draw, 50);

    // --- User Data Load ---
    firebase.auth().onAuthStateChanged(user => {
        if (!user) window.location.href = "index.html";
        else {
            document.getElementById('user-email').innerText = user.email;
            db.ref('users/' + user.uid).on('value', s => {
                const data = s.val() || {};
                document.getElementById('username').value = data.username || "";
                document.getElementById('display-name').innerText = data.username || user.email.split('@')[0];
                document.getElementById('bio').value = data.bio || "";
                
                // Avatar Priority: Link > Emoji > Default
                const avatarView = document.getElementById('avatar-view');
                if (data.profilePic && data.profilePic.startsWith('http')) {
                    avatarView.innerHTML = `<img src="${data.profilePic}" style="width:100%; height:100%; object-fit:cover;">`;
                } else {
                    avatarView.innerHTML = data.profilePic || "ðŸ‘¤";
                }
            });
        }
    });

    // --- ImgBB á€•á€¯á€¶á€á€„á€ºá€á€²á€· Function ---
    async function uploadAvatar(input) {
        if (!input.files || !input.files[0]) return;
        
        const status = document.getElementById('status');
        status.innerText = "á€•á€¯á€¶á€á€„á€ºá€”á€­á€”á€ºá€•á€«á€›á€±... á€á€”á€¬á€¸á€á€»á€±á€…á€±á€¬á€„á€·á€ºá€•á€«";
        
        const fd = new FormData();
        fd.append("image", input.files[0]);

        try {
            // ImgBB API á€žá€¯á€¶á€¸á€•á€¼á€®á€¸ á€•á€¯á€¶á€á€„á€ºá€á€¼á€„á€ºá€¸
            const res = await fetch("https://api.imgbb.com/1/upload?key=926060156d59194f53e97f7cec5ff5a2", {
                method: "POST",
                body: fd
            });
            const resData = await res.json();
            if (resData.success) {
                const imgUrl = resData.data.url;
                const user = firebase.auth().currentUser;
                // Database á€‘á€²á€™á€¾á€¬ Profile á€•á€¯á€¶ Link á€€á€­á€¯ Update á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
                await db.ref('users/' + user.uid).update({ profilePic: imgUrl });
                status.innerText = "á€•á€›á€­á€¯á€–á€­á€¯á€„á€ºá€•á€¯á€¶ á€•á€¼á€±á€¬á€„á€ºá€¸á€•á€¼á€®á€¸á€•á€«á€šá€¬!";
            }
        } catch (e) {
            status.innerText = "á€•á€¯á€¶á€á€„á€ºá€œá€­á€¯á€· á€™á€›á€•á€« (Error)!";
        }
    }

    // --- á€¡á€á€»á€€á€ºá€¡á€œá€€á€º á€žá€­á€™á€ºá€¸á€á€¼á€„á€ºá€¸ ---
    function saveProfile() {
        const user = firebase.auth().currentUser;
        const name = document.getElementById('username').value;
        const bio = document.getElementById('bio').value;
        const btn = document.getElementById('saveBtn');

        btn.disabled = true;
        db.ref('users/' + user.uid).update({
            username: name,
            bio: bio
        }).then(() => {
            btn.disabled = false;
            document.getElementById('status').innerText = "á€žá€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€•á€¼á€®á€¸á€•á€«á€šá€¬!";
            setTimeout(() => document.getElementById('status').innerText = "", 2000);
        });
    }
</script>
</body>
</html>
