<!DOCTYPE html>
<html>
<head>
    <title>User Profile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <style>
        body { background: #0a0a0a; color: #333; font-family: sans-serif; margin: 0; padding: 10px; }
        .profile-card { max-width: 450px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,255,65,0.3); text-align: center; }
        .profile-img { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 4px solid #00ff41; margin-bottom: 10px; background: #eee; }
        .info-table { text-align: left; margin-top: 20px; width: 100%; border-collapse: collapse; }
        .info-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .bio-box { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-top: 15px; font-style: italic; text-align: left; min-height: 50px; }
        
        /* Form Styling */
        #edit-section { display: none; margin-top: 20px; border-top: 2px dashed #00ff41; padding-top: 20px; text-align: left; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; background: #fff; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-edit { background: #00ff41; color: #000; }
        .btn-save { background: #007bff; color: #fff; }
        .btn-back { background: #666; color: #fff; }
    </style>
</head>
<body>

<div class="profile-card">
    <img id="p-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
    <h2 id="p-name">Loading...</h2>
    
    <table class="info-table">
        <tr><td><b>အသက်</b></td><td id="p-age">--</td></tr>
        <tr><td><b>လိင်</b></td><td id="p-gender">--</td></tr>
        <tr><td><b>မွေးနေ့</b></td><td id="p-dob">--</td></tr>
    </table>

    <div class="bio-box">
        <h4 style="margin:0 0 5px 0;">စာတိုလေး (Bio)</h4>
        <p id="p-bio" style="margin:0;">...</p>
    </div>

    <button id="edit-btn" class="btn btn-edit" style="display:none;" onclick="toggleEdit()">ပြင်ဆင်မေ</button>
    <button class="btn btn-back" onclick="window.history.back()">ပြန်လားမေ</button>

    <div id="edit-section">
        <h3 style="color:#007bff;">အချက်အလက်ပြင်မေ</h3>
        
        <label>နာမည်:</label>
        <input type="text" id="input-name">

        <label>ပရိုဖိုင်ပုံ ရွေးပါ:</label>
        <input type="file" id="input-file" accept="image/*">

        <label>အသက်:</label>
        <input type="number" id="input-age">

        <label>လိင်:</label>
        <select id="input-gender">
            <option value="ကျား">ကျား</option>
            <option value="မ">မ</option>
            <option value="အခြား">အခြား</option>
        </select>

        <label>မွေးနေ့:</label>
        <input type="date" id="input-dob">

        <label>ကိုယ့်အကြောင်း (Bio):</label>
        <textarea id="input-bio" rows="3"></textarea>

        <button id="save-btn" class="btn btn-save" onclick="saveProfile()">သိမ်းဆည်းမေ</button>
    </div>
</div>

<script>
    // ကိုကို့ Firebase Config (မူရင်းအတိုင်း)
    const config = {
        apiKey: "AIzaSyCpIv3avDNRYNrmrzKdMqfnMdNzBGZAPow",
        authDomain: "firstarakha.firebaseapp.com",
        projectId: "firstarakha",
        databaseURL: "https://firstarakha-default-rtdb.asia-southeast1.firebasedatabase.app",
        storageBucket: "firstarakha.appspot.com", // Storage အတွက် ဒါလေးပါဖို့လိုတယ်
        appId: "1:4263070909:web:ef4e4a2c0891be1f49bbd4"
    };
    firebase.initializeApp(config);
    const db = firebase.database();
    const storage = firebase.storage();

    const params = new URLSearchParams(window.location.search);
    const profileId = params.get('id');

    // ၁။ ဒေတာများကို Firebase မှ ဆွဲထုတ်ခြင်း
    if (profileId) {
        db.ref('users/' + profileId).on('value', s => {
            const data = s.val();
            if (data) {
                document.getElementById('p-name').innerText = data.username || "အမည်မသိ";
                document.getElementById('p-age').innerText = data.age || "--";
                document.getElementById('p-gender').innerText = data.gender || "--";
                document.getElementById('p-dob').innerText = data.dob || "--";
                document.getElementById('p-bio').innerText = data.bio || "ဘာမှမရေးထားပါဘူး။";
                document.getElementById('p-img').src = data.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";

                // Input တွေထဲကိုပါ ဒေတာ ကြိုဖြည့်ပေးခြင်း
                document.getElementById('input-name').value = data.username || "";
                document.getElementById('input-age').value = data.age || "";
                document.getElementById('input-gender').value = data.gender || "ကျား";
                document.getElementById('input-dob').value = data.dob || "";
                document.getElementById('input-bio').value = data.bio || "";
            }
        });
    }

    // ၂။ ပရိုဖိုင်ပိုင်ရှင် ဟုတ်မဟုတ် စစ်ဆေးခြင်း
    firebase.auth().onAuthStateChanged(user => {
        if (user && user.uid === profileId) {
            document.getElementById('edit-btn').style.display = 'block';
        }
    });

    function toggleEdit() {
        const x = document.getElementById('edit-section');
        x.style.display = (x.style.display === 'none') ? 'block' : 'none';
    }

    // ၃။ ပရိုဖိုင် သိမ်းဆည်းခြင်း (Upload ရော Update ရောပါဝင်သည်)
    async function saveProfile() {
        const user = firebase.auth().currentUser;
        const file = document.getElementById('input-file').files[0];
        const saveBtn = document.getElementById('save-btn');

        if (!user || user.uid !== profileId) return;

        saveBtn.innerText = "သိမ်းနီပါရေ... (ခဏစောင့်ပါ)";
        saveBtn.disabled = true;

        let photoURL = document.getElementById('p-img').src;

        try {
            // ပုံအသစ်ရွေးထားရင် Storage ထဲ အရင်တင်မယ်
            if (file) {
                const storageRef = storage.ref('profile_pics/' + user.uid);
                await storageRef.put(file);
                photoURL = await storageRef.getDownloadURL();
            }

            const updatedData = {
                username: document.getElementById('input-name').value,
                profilePic: photoURL,
                age: document.getElementById('input-age').value,
                gender: document.getElementById('input-gender').value,
                dob: document.getElementById('input-dob').value,
                bio: document.getElementById('input-bio').value
            };

            // Database ကို Update လုပ်မယ်
            await db.ref('users/' + user.uid).update(updatedData);

            // Auth Profile (displayName) ကိုပါ Update လုပ်မယ်
            await user.updateProfile({ 
                displayName: updatedData.username,
                photoURL: photoURL 
            });

            alert("အောင်မြင်စွာ ပြင်ဆင်ပြီးပါယာ!");
            toggleEdit();
            saveBtn.disabled = false;
            saveBtn.innerText = "သိမ်းဆည်းမေ";
        } catch (e) {
            alert("Error: " + e.message);
            saveBtn.disabled = false;
            saveBtn.innerText = "သိမ်းဆည်းမေ";
        }
    }
</script>
</body>
</html>
